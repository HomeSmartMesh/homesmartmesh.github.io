---
import { relAssetToUrl, relAssetToPath } from '../../libs/assets.js'
import { exists } from '../../libs/utils.js'

export interface Props {
  src: string; // URL to original image
  rel: string; // relative path inside content dir (e.g. "room_view_bot/img.jpg")
  dirpath: string; // content section dirpath
  width?: number;
  height?: number;
  alt?: string;
  title?: string;
  class?: string;
  sizes?: string; // optional override
  masonry?: boolean; // used to compute default sizes
  loading?: 'lazy' | 'eager';
  decoding?: 'async' | 'sync' | 'auto';
}

const {
  src,
  rel,
  dirpath,
  width,
  height,
  alt = '',
  title = '',
  class: className = '',
  sizes: sizesProp,
  masonry = false,
  loading = 'lazy',
  decoding = 'async',
} = Astro.props as Props;

// Determine candidate target widths based on original dimensions
const originalW = width ?? 0;
const candidateWidths: number[] = [];
if (originalW > 1280) candidateWidths.push(640);
if (originalW > 640) candidateWidths.push(320);

// Map rel (inside dirpath) to sizes path: first segment gets _sizes suffix
function toSizesRel(relPath: string): { dirRel: string; name: string } {
  const normalized = relPath.replaceAll('\\', '/');
  const parts = normalized.split('/');
  const firstSeg = parts.shift() || '';
  const rest = parts.join('/');
  const sizesRoot = `${firstSeg}_sizes`;
  const name = (rest ? rest.split('/').pop() : firstSeg).split('.').slice(0, -1).join('.') || (rest ? rest.split('/').pop() : firstSeg);
  const dirOnly = rest ? rest.split('/').slice(0, -1).join('/') : '';
  const dirRel = dirOnly ? `${sizesRoot}/${dirOnly}` : sizesRoot;
  return { dirRel, name };
}

// Probe filesystem for available WebP variants and build srcset
const variants: Array<{ w: number; url: string }> = [];
if (candidateWidths.length && rel) {
  const { dirRel, name } = toSizesRel(rel);
  for (const w of candidateWidths.sort((a,b)=>a-b)) {
    const relCandidate = `${dirRel}/${name}-${w}.webp`;
    const absCandidate = relAssetToPath(relCandidate, dirpath);
    if (await exists(absCandidate)) {
      const url = await relAssetToUrl(relCandidate, dirpath);
      variants.push({ w, url });
    }
  }
}

const hasVariants = variants.length > 0;
const srcset = hasVariants ? variants.map(v => `${v.url} ${v.w}w`).join(', ') : undefined;

function defaultSizes(masonry: boolean): string {
  return masonry
    ? '(max-width: 600px) 100vw, 20rem'
    : '(max-width: 700px) 100vw, (max-width: 1100px) 33vw, 25vw';
}

const sizesAttr = sizesProp ?? defaultSizes(masonry);
---
{hasVariants ? (
  <picture class={className}>
    <source type="image/webp" srcset={srcset} sizes={sizesAttr} />
    <img src={src} width={width} height={height} alt={alt} title={title} loading={loading} decoding={decoding} />
  </picture>
) : (
  <img class={className} src={src} width={width} height={height} alt={alt} title={title} loading={loading} decoding={decoding} />
)}

<style>
:global(picture), :global(img) {
  display: block;
  width: 100%;
  height: 100%;
}
:global(img) {
  object-fit: cover;
}
</style>
